/*!
 * froala_editor v3.2.6 (https://www.froala.com/wysiwyg-editor)
 * License https://froala.com/wysiwyg-editor/terms/
 * Copyright 2014-2021 Froala Labs
 */

{"version":3,"file":"file.js","sources":["../../../src/js/plugins/file.js"],"sourcesContent":["import FE from '../index.js'\r\n'use strict';\r\n\r\nObject.assign(FE.POPUP_TEMPLATES, {\r\n  'file.insert': '[_BUTTONS_][_UPLOAD_LAYER_][_PROGRESS_BAR_]'\r\n})\r\n\r\n// Extend defaults.\r\nObject.assign(FE.DEFAULTS, {\r\n  fileUpload: true,\r\n  fileUploadURL: null,\r\n  fileUploadParam: 'file',\r\n  fileUploadParams: {},\r\n  fileUploadToS3: false,\r\n  fileUploadToAzure: false,\r\n  fileUploadMethod: 'POST',\r\n  fileMaxSize: 10 * 1024 * 1024,\r\n  fileAllowedTypes: ['*'],\r\n  fileInsertButtons: ['fileBack', '|'],\r\n  fileUseSelectedText: false\r\n})\r\n\r\nFE.PLUGINS.file = function (editor) {\r\n  const { $ } = editor\r\n  const DEFAULT_FILE_UPLOAD_URL = 'https://i.froala.com/upload'\r\n\r\n  const BAD_LINK = 1\r\n  const MISSING_LINK = 2\r\n  const ERROR_DURING_UPLOAD = 3\r\n  const BAD_RESPONSE = 4\r\n  const MAX_SIZE_EXCEEDED = 5\r\n  const BAD_FILE_TYPE = 6\r\n  const NO_CORS_IE = 7\r\n\r\n  const error_messages = {}\r\n  error_messages[BAD_LINK] = 'File cannot be loaded from the passed link.'\r\n  error_messages[MISSING_LINK] = 'No link in upload response.'\r\n  error_messages[ERROR_DURING_UPLOAD] = 'Error during file upload.'\r\n  error_messages[BAD_RESPONSE] = 'Parsing response failed.'\r\n  error_messages[MAX_SIZE_EXCEEDED] = 'File is too large.'\r\n  error_messages[BAD_FILE_TYPE] = 'File file type is invalid.'\r\n  error_messages[NO_CORS_IE] = 'Files can be uploaded only to same domain in IE 8 and IE 9.'\r\n\r\n  function showInsertPopup() {\r\n    const $btn = editor.$tb.find('.fr-command[data-cmd=\"insertFile\"]')\r\n\r\n    let $popup = editor.popups.get('file.insert')\r\n\r\n    if (!$popup) $popup = _initInsertPopup()\r\n\r\n    hideProgressBar()\r\n\r\n    if (!$popup.hasClass('fr-active')) {\r\n      editor.popups.refresh('file.insert')\r\n      editor.popups.setContainer('file.insert', editor.$tb)\r\n\r\n      if ($btn.isVisible) {\r\n        const { left, top } = editor.button.getPosition($btn)\r\n        editor.popups.show('file.insert', left, top, $btn.outerHeight())\r\n      }\r\n      else {\r\n        editor.position.forSelection($popup)\r\n        editor.popups.show('file.insert')\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show progress bar.\r\n   */\r\n  function showProgressBar() {\r\n    let $popup = editor.popups.get('file.insert')\r\n\r\n    if (!$popup) $popup = _initInsertPopup()\r\n\r\n    $popup.find('.fr-layer.fr-active').removeClass('fr-active').addClass('fr-pactive')\r\n    $popup.find('.fr-file-progress-bar-layer').addClass('fr-active')\r\n    $popup.find('.fr-buttons').hide()\r\n\r\n    _setProgressMessage(editor.language.translate('Uploading'), 0)\r\n  }\r\n\r\n  /**\r\n   * Hide progress bar.\r\n   */\r\n  function hideProgressBar(dismiss) {\r\n    const $popup = editor.popups.get('file.insert')\r\n\r\n    if ($popup) {\r\n      $popup.find('.fr-layer.fr-pactive').addClass('fr-active').removeClass('fr-pactive')\r\n      $popup.find('.fr-file-progress-bar-layer').removeClass('fr-active')\r\n      $popup.find('.fr-buttons').show()\r\n\r\n      if (dismiss) {\r\n        editor.events.focus()\r\n        editor.popups.hide('file.insert')\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set a progress message.\r\n   */\r\n  function _setProgressMessage(message, progress) {\r\n    const $popup = editor.popups.get('file.insert')\r\n\r\n    if ($popup) {\r\n      const $layer = $popup.find('.fr-file-progress-bar-layer')\r\n      $layer.find('h3').text(message + (progress ? ` ${progress}%` : ''))\r\n\r\n      $layer.removeClass('fr-error')\r\n\r\n      if (progress) {\r\n        $layer.find('div').removeClass('fr-indeterminate')\r\n        $layer.find('div > span').css('width', `${progress}%`)\r\n      }\r\n      else {\r\n        $layer.find('div').addClass('fr-indeterminate')\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show error message to the user.\r\n   */\r\n  function _showErrorMessage(message) {\r\n    showProgressBar()\r\n    const $popup = editor.popups.get('file.insert')\r\n    const $layer = $popup.find('.fr-file-progress-bar-layer')\r\n    $layer.addClass('fr-error')\r\n    const $message_header = $layer.find('h3')\r\n    $message_header.text(message)\r\n    editor.events.disableBlur()\r\n    $message_header.focus()\r\n  }\r\n\r\n  /**\r\n   * Insert the uploaded file.\r\n   */\r\n  function insert(link, text, response) {\r\n    editor.edit.on()\r\n\r\n    // Focus in the editor.\r\n    editor.events.focus(true)\r\n    editor.selection.restore()\r\n\r\n    if (editor.opts.fileUseSelectedText && editor.selection.text().length) {\r\n      text = editor.selection.text()\r\n    }\r\n\r\n    // Insert the link.\r\n    editor.html.insert(`<a href=\"${link}\" target=\"_blank\" id=\"fr-inserted-file\" class=\"fr-file\">${text}</a>`)\r\n\r\n    // Get the file.\r\n    const $file = editor.$el.find('#fr-inserted-file')\r\n\r\n    $file.removeAttr('id')\r\n\r\n    editor.popups.hide('file.insert')\r\n\r\n    editor.undo.saveStep()\r\n\r\n    _syncFiles()\r\n\r\n    editor.events.trigger('file.inserted', [$file, response])\r\n  }\r\n\r\n  /**\r\n   * Parse file response.\r\n   */\r\n  function _parseResponse(response) {\r\n    try {\r\n      if (editor.events.trigger('file.uploaded', [response], true) === false) {\r\n        editor.edit.on()\r\n\r\n        return false\r\n      }\r\n\r\n      const resp = JSON.parse(response)\r\n\r\n      if (resp.link) {\r\n\r\n        return resp\r\n      }\r\n      else {\r\n\r\n        // No link in upload request.\r\n        _throwError(MISSING_LINK, response)\r\n\r\n        return false\r\n      }\r\n    }\r\n    catch (ex) {\r\n\r\n      // Bad response.\r\n      _throwError(BAD_RESPONSE, response)\r\n\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse file response.\r\n   */\r\n  function _parseXMLResponse(response) {\r\n    try {\r\n      const link = $(response).find('Location').text()\r\n      const key = $(response).find('Key').text()\r\n\r\n      if (editor.events.trigger('file.uploadedToS3', [link, key, response], true) === false) {\r\n        editor.edit.on()\r\n\r\n        return false\r\n      }\r\n\r\n      return link\r\n    }\r\n    catch (ex) {\r\n\r\n      // Bad response.\r\n      _throwError(BAD_RESPONSE, response)\r\n\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * File was uploaded to the server and we have a response.\r\n   */\r\n  function _fileUploaded(text, url, key) {\r\n    const { status } = this\r\n    const { response } = this\r\n    const { responseXML } = this\r\n    const { responseText } = this\r\n\r\n    try {\r\n      if (editor.opts.fileUploadToS3 || editor.opts.fileUploadToAzure) {\r\n        if (status === 201) {\r\n          let link\r\n          if(editor.opts.fileUploadToAzure) {\r\n            if (editor.events.trigger('file.uploadedToAzure', [this.responseURL, key, response], true) === false) {\r\n              editor.edit.on()\r\n              return false\r\n            }\r\n            link = url\r\n          } else {\r\n            link = _parseXMLResponse(responseXML)\r\n          }\r\n\r\n          if (link) {\r\n            insert(link, text, response || responseXML)\r\n          }\r\n        }\r\n        else {\r\n          _throwError(BAD_RESPONSE, response || responseXML)\r\n        }\r\n      }\r\n      else {\r\n        if (status >= 200 && status < 300) {\r\n          const resp = _parseResponse(responseText)\r\n\r\n          if (resp) {\r\n            insert(resp.link, text, response || responseText)\r\n          }\r\n        }\r\n        else {\r\n          _throwError(ERROR_DURING_UPLOAD, response || responseText)\r\n        }\r\n      }\r\n    }\r\n    catch (ex) {\r\n\r\n      // Bad response.\r\n      _throwError(BAD_RESPONSE, response || responseText)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * File upload error.\r\n   */\r\n  function _fileUploadError() {\r\n    _throwError(BAD_RESPONSE, this.response || this.responseText || this.responseXML)\r\n  }\r\n\r\n  /**\r\n   * File upload progress.\r\n   */\r\n  function _fileUploadProgress(e) {\r\n    if (e.lengthComputable) {\r\n      const complete = (e.loaded / e.total * 100 | 0)\r\n      _setProgressMessage(editor.language.translate('Uploading'), complete)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Throw an file error.\r\n   */\r\n  function _throwError(code, response) {\r\n    editor.edit.on()\r\n    _showErrorMessage(editor.language.translate('Something went wrong. Please try again.'))\r\n\r\n    editor.events.trigger('file.error', [{\r\n      code: code,\r\n      message: error_messages[code]\r\n    }, response])\r\n  }\r\n\r\n  /**\r\n   * File upload aborted.\r\n   */\r\n  function _fileUploadAborted() {\r\n    editor.edit.on()\r\n    hideProgressBar(true)\r\n  }\r\n\r\n  function _browserUpload(file) {\r\n    const reader = new FileReader()\r\n\r\n    reader.onload = function () {\r\n      let { result : link } = reader\r\n\r\n      // Convert image to local blob.\r\n      const binary = atob(reader.result.split(',')[1])\r\n      const array = []\r\n\r\n      for (let i = 0; i < binary.length; i++) {\r\n        array.push(binary.charCodeAt(i))\r\n      }\r\n\r\n      // Get local image link.\r\n      link = window.URL.createObjectURL(new Blob([new Uint8Array(array)], {\r\n        type: file.type\r\n      }))\r\n\r\n      editor.file.insert(link, file.name, null)\r\n    }\r\n\r\n    showProgressBar()\r\n\r\n    reader.readAsDataURL(file)\r\n  }\r\n\r\n\r\n  function upload(files) {\r\n\r\n    // Make sure we have what to upload.\r\n    if (typeof files !== 'undefined' && files.length > 0) {\r\n\r\n      // Check if we should cancel the file upload.\r\n      if (editor.events.trigger('file.beforeUpload', [files]) === false) {\r\n\r\n        return false\r\n      }\r\n\r\n\r\n      const file = files[0]\r\n\r\n      // Upload as blob for testing purposes.\r\n      if ((editor.opts.fileUploadURL === null || editor.opts.fileUploadURL === DEFAULT_FILE_UPLOAD_URL) && !editor.opts.fileUploadToS3 && !editor.opts.fileUploadToAzure) {\r\n        _browserUpload(file)\r\n\r\n        return false\r\n      }\r\n\r\n      // Check file max size.\r\n      if (file.size > editor.opts.fileMaxSize) {\r\n        _throwError(MAX_SIZE_EXCEEDED)\r\n\r\n        return false\r\n      }\r\n\r\n      // Check file types.\r\n      if (editor.opts.fileAllowedTypes.indexOf('*') < 0 && editor.opts.fileAllowedTypes.indexOf(file.type.replace(/file\\//g, '')) < 0) {\r\n        _throwError(BAD_FILE_TYPE)\r\n\r\n        return false\r\n      }\r\n\r\n      // Create form Data.\r\n      let form_data\r\n\r\n      if (editor.drag_support.formdata) {\r\n        form_data = editor.drag_support.formdata ? new FormData() : null\r\n      }\r\n\r\n      // Prepare form data for request.\r\n      if (form_data) {\r\n        let key\r\n\r\n        // Upload to S3.\r\n        if (editor.opts.fileUploadToS3 !== false) {\r\n          form_data.append('key', editor.opts.fileUploadToS3.keyStart + (new Date()).getTime() + '-' + (file.name || 'untitled'))\r\n          form_data.append('success_action_status', '201')\r\n          form_data.append('X-Requested-With', 'xhr')\r\n          form_data.append('Content-Type', file.type)\r\n\r\n          for (key in editor.opts.fileUploadToS3.params) {\r\n            if (editor.opts.fileUploadToS3.params.hasOwnProperty(key)) {\r\n              form_data.append(key, editor.opts.fileUploadToS3.params[key])\r\n            }\r\n          }\r\n        }\r\n\r\n        // Add upload params.\r\n        for (key in editor.opts.fileUploadParams) {\r\n          if (editor.opts.fileUploadParams.hasOwnProperty(key)) {\r\n            form_data.append(key, editor.opts.fileUploadParams[key])\r\n          }\r\n        }\r\n\r\n        // Set the file in the request.\r\n        form_data.append(editor.opts.fileUploadParam, file)\r\n\r\n        // Create XHR request.\r\n        let { fileUploadURL : url } = editor.opts\r\n\r\n        if (editor.opts.fileUploadToS3) {\r\n          if (editor.opts.fileUploadToS3.uploadURL) {\r\n            url = editor.opts.fileUploadToS3.uploadURL\r\n          }\r\n          else {\r\n            url = `https://${editor.opts.fileUploadToS3.region}.amazonaws.com/${editor.opts.fileUploadToS3.bucket}`\r\n          }\r\n        }\r\n        let fileURL\r\n        let azureKey\r\n        let fileUploadMethod = editor.opts.fileUploadMethod\r\n        if (editor.opts.fileUploadToAzure) {\r\n          if (editor.opts.fileUploadToAzure.uploadURL) {\r\n            url = `${editor.opts.fileUploadToAzure.uploadURL}/${file.name}`\r\n          } else {\r\n            url = encodeURI(`https://${editor.opts.fileUploadToAzure.account}.blob.core.windows.net/${editor.opts.fileUploadToAzure.container}/${file.name}`)\r\n          }\r\n          fileURL = url\r\n          if (editor.opts.fileUploadToAzure.SASToken) {\r\n            url +=  editor.opts.fileUploadToAzure.SASToken\r\n          }\r\n          fileUploadMethod = 'PUT'\r\n        }        \r\n        \r\n        const xhr = editor.core.getXHR(url, fileUploadMethod)\r\n\r\n        if (editor.opts.fileUploadToAzure) {\r\n          let uploadDate = new Date().toUTCString()\r\n          if (!editor.opts.fileUploadToAzure.SASToken && editor.opts.fileUploadToAzure.accessKey) {\r\n            let azureAccount = editor.opts.fileUploadToAzure.account\r\n            let azureContainer = editor.opts.fileUploadToAzure.container\r\n            if(editor.opts.fileUploadToAzure.uploadURL) {\r\n              let urls = editor.opts.fileUploadToAzure.uploadURL.split('/')\r\n              azureContainer = urls.pop()\r\n              azureAccount = urls.pop().split('.')[0]\r\n            }\r\n            let headerResource = `x-ms-blob-type:BlockBlob\\nx-ms-date:${uploadDate}\\nx-ms-version:2019-07-07`\r\n            let urlResource = encodeURI('/' + azureAccount + '/' + azureContainer + '/' + file.name)\r\n            let stringToSign = fileUploadMethod + '\\n\\n\\n' + file.size + '\\n\\n' + file.type + '\\n\\n\\n\\n\\n\\n\\n' + headerResource + '\\n' + urlResource\r\n            let signatureBytes = editor.cryptoJSPlugin.cryptoJS.HmacSHA256(stringToSign, editor.cryptoJSPlugin.cryptoJS.enc.Base64.parse(editor.opts.fileUploadToAzure.accessKey))\r\n            let signature = signatureBytes.toString(editor.cryptoJSPlugin.cryptoJS.enc.Base64)\r\n            let authHeader = 'SharedKey ' + azureAccount + ':' + signature\r\n            azureKey = signature\r\n            xhr.setRequestHeader(\"Authorization\", authHeader)\r\n          }\r\n          xhr.setRequestHeader(\"x-ms-version\", \"2019-07-07\")\r\n          xhr.setRequestHeader(\"x-ms-date\", uploadDate)\r\n          xhr.setRequestHeader(\"Content-Type\", file.type)\r\n          xhr.setRequestHeader(\"x-ms-blob-type\", \"BlockBlob\")\r\n          for (key in editor.opts.fileUploadParams) {\r\n            if (editor.opts.fileUploadParams.hasOwnProperty(key)) {\r\n              xhr.setRequestHeader(key, editor.opts.fileUploadParams[key])\r\n            }\r\n          }\r\n          for (key in editor.opts.fileUploadToAzure.params) {\r\n            if (editor.opts.fileUploadToAzure.params.hasOwnProperty(key)) {\r\n              xhr.setRequestHeader(key, editor.opts.fileUploadToAzure.params[key])\r\n            }\r\n          }\r\n        }\r\n        // Set upload events.\r\n        xhr.onload = function () {\r\n          _fileUploaded.call(xhr, file.name, fileURL, azureKey)\r\n        }\r\n        xhr.onerror = _fileUploadError\r\n        xhr.upload.onprogress = _fileUploadProgress\r\n        xhr.onabort = _fileUploadAborted\r\n\r\n        showProgressBar()\r\n\r\n        // editor.edit.off()\r\n\r\n        const $popup = editor.popups.get('file.insert')\r\n\r\n        if ($popup) {\r\n          $popup.off('abortUpload')\r\n          $popup.on('abortUpload', function () {\r\n            if (xhr.readyState !== 4) {\r\n              xhr.abort()\r\n            }\r\n          })\r\n        }\r\n\r\n        // Send data.\r\n      xhr.send(editor.opts.fileUploadToAzure ? file : form_data)   \r\n      }\r\n    }\r\n  }\r\n\r\n  function _bindInsertEvents($popup) {\r\n\r\n    // Drag over the dropable area.\r\n    editor.events.$on($popup, 'dragover dragenter', '.fr-file-upload-layer', function () {\r\n      $(this).addClass('fr-drop')\r\n\r\n      return false\r\n    }, true)\r\n\r\n    // Drag end.\r\n    editor.events.$on($popup, 'dragleave dragend', '.fr-file-upload-layer', function () {\r\n      $(this).removeClass('fr-drop')\r\n\r\n      return false\r\n    }, true)\r\n\r\n    // Drop.\r\n    editor.events.$on($popup, 'drop', '.fr-file-upload-layer', function (e) {\r\n      e.preventDefault()\r\n      e.stopPropagation()\r\n\r\n      $(this).removeClass('fr-drop')\r\n\r\n      const { dataTransfer : dt } = e.originalEvent\r\n\r\n      if (dt && dt.files) {\r\n        const inst = $popup.data('instance') || editor\r\n        inst.file.upload(dt.files)\r\n      }\r\n    }, true)\r\n\r\n    if (editor.helpers.isIOS()) {\r\n      editor.events.$on($popup, 'touchstart', '.fr-file-upload-layer input[type=\"file\"]', function () {\r\n        $(this).trigger('click')\r\n      })\r\n    }\r\n\r\n    editor.events.$on($popup, 'change', '.fr-file-upload-layer input[type=\"file\"]', function () {\r\n      if (this.files) {\r\n        const inst = $popup.data('instance') || editor\r\n\r\n        inst.events.disableBlur()\r\n        $popup.find('input:focus').blur()\r\n        inst.events.enableBlur()\r\n\r\n        inst.file.upload(this.files)\r\n      }\r\n\r\n      // Else IE 9 case.\r\n\r\n      // Chrome fix.\r\n      $(this).val('')\r\n    }, true)\r\n  }\r\n\r\n  function _hideInsertPopup() {\r\n    hideProgressBar()\r\n  }\r\n\r\n  function _initInsertPopup(delayed) {\r\n    if (delayed) {\r\n      editor.popups.onHide('file.insert', _hideInsertPopup)\r\n\r\n      return true\r\n    }\r\n\r\n    // Image buttons.\r\n    let file_buttons = ''\r\n\r\n    if (!editor.opts.fileUpload) {\r\n      editor.opts.fileInsertButtons.splice(editor.opts.fileInsertButtons.indexOf('fileUpload'), 1)\r\n    }\r\n\r\n    file_buttons = `<div class=\"fr-buttons fr-tabs\">${editor.button.buildList(editor.opts.fileInsertButtons)}</div>`\r\n\r\n    // File upload layer.\r\n    let upload_layer = ''\r\n\r\n    if (editor.opts.fileUpload) {\r\n      upload_layer = `<div class=\"fr-file-upload-layer fr-layer fr-active\" id=\"fr-file-upload-layer-${editor.id}\"><strong>${editor.language.translate('Drop file')}</strong><br>(${editor.language.translate('or click')})<div class=\"fr-form\"><input type=\"file\" name=\"${editor.opts.fileUploadParam}\" accept=\"${(editor.opts.fileAllowedTypes.indexOf('*') >= 0 ? '/' : '')}${editor.opts.fileAllowedTypes.join(', ').toLowerCase()}\" tabIndex=\"-1\" aria-labelledby=\"fr-file-upload-layer-${editor.id}\" role=\"button\"></div></div>`\r\n    }\r\n\r\n\r\n    // Progress bar.\r\n    const progress_bar_layer = '<div class=\"fr-file-progress-bar-layer fr-layer\"><h3 tabIndex=\"-1\" class=\"fr-message\">Uploading</h3><div class=\"fr-loader\"><span class=\"fr-progress\"></span></div><div class=\"fr-action-buttons\"><button type=\"button\" class=\"fr-command fr-dismiss\" data-cmd=\"fileDismissError\" tabIndex=\"2\" role=\"button\">OK</button></div></div>'\r\n\r\n    const template = {\r\n      buttons: file_buttons,\r\n      upload_layer: upload_layer,\r\n      progress_bar: progress_bar_layer\r\n    }\r\n\r\n    // Set the template in the popup.\r\n    const $popup = editor.popups.create('file.insert', template)\r\n\r\n    _bindInsertEvents($popup)\r\n\r\n    return $popup\r\n  }\r\n\r\n  function _onRemove(link) {\r\n    if (editor.node.hasClass(link, 'fr-file')) {\r\n\r\n      return\r\n    }\r\n  }\r\n\r\n  function _drop(e) {\r\n\r\n    // Check if we are dropping files.\r\n    const { dataTransfer : dt } = e.originalEvent\r\n\r\n    if (dt && dt.files && dt.files.length) {\r\n      const file = dt.files[0]\r\n\r\n      if (file && typeof file.type !== 'undefined') {\r\n\r\n        // Dropped file is an file that we allow.\r\n        if (file.type.indexOf('image') < 0) {\r\n          if (!editor.opts.fileUpload) {\r\n            e.preventDefault()\r\n            e.stopPropagation()\r\n\r\n            return false\r\n          }\r\n\r\n\r\n          editor.markers.remove()\r\n          editor.markers.insertAtPoint(e.originalEvent)\r\n          editor.$el.find('.fr-marker').replaceWith(FE.MARKERS)\r\n\r\n          // Hide popups.\r\n          editor.popups.hideAll()\r\n\r\n          // Show the file insert popup.\r\n          let $popup = editor.popups.get('file.insert')\r\n\r\n          if (!$popup) $popup = _initInsertPopup()\r\n          editor.popups.setContainer('file.insert', editor.$sc)\r\n          editor.popups.show('file.insert', e.originalEvent.pageX, e.originalEvent.pageY)\r\n          showProgressBar()\r\n\r\n          // Upload files.\r\n          upload(dt.files)\r\n\r\n          // Cancel anything else.\r\n          e.preventDefault()\r\n          e.stopPropagation()\r\n\r\n          return false\r\n        }\r\n      }\r\n      else if (file.type.indexOf('image') < 0) {\r\n        e.preventDefault()\r\n        e.stopPropagation()\r\n      }\r\n    }\r\n  }\r\n\r\n  function _initEvents() {\r\n\r\n    // Drop inside the editor.\r\n    editor.events.on('drop', _drop)\r\n\r\n    editor.events.$on(editor.$win, 'keydown', function (e) {\r\n      const key_code = e.which\r\n      const $popup = editor.popups.get('file.insert')\r\n\r\n      if ($popup && key_code === FE.KEYCODE.ESC) {\r\n        $popup.trigger('abortUpload')\r\n      }\r\n    })\r\n\r\n    editor.events.on('destroy', function () {\r\n      const $popup = editor.popups.get('file.insert')\r\n\r\n      if ($popup) {\r\n        $popup.trigger('abortUpload')\r\n      }\r\n    })\r\n  }\r\n\r\n  function back() {\r\n    editor.events.disableBlur()\r\n    editor.selection.restore()\r\n    editor.events.enableBlur()\r\n\r\n    editor.popups.hide('file.insert')\r\n    editor.toolbar.showInline()\r\n  }\r\n\r\n  let files\r\n\r\n  function _syncFiles() {\r\n\r\n    // Get current files.\r\n    const c_files = Array.prototype.slice.call(editor.el.querySelectorAll('a.fr-file'))\r\n\r\n    // Current files src.\r\n    const file_srcs = []\r\n    let i\r\n\r\n    for (i = 0; i < c_files.length; i++) {\r\n      file_srcs.push(c_files[i].getAttribute('href'))\r\n    }\r\n\r\n    // Loop previous files and check their src.\r\n    if (files) {\r\n      for (i = 0; i < files.length; i++) {\r\n        if (file_srcs.indexOf(files[i].getAttribute('href')) < 0) {\r\n          editor.events.trigger('file.unlink', [files[i]])\r\n        }\r\n      }\r\n    }\r\n\r\n    // Current files are the old ones.\r\n    files = c_files\r\n  }\r\n\r\n  /*\r\n   * Initialize.\r\n   */\r\n  function _init() {\r\n    _initEvents()\r\n\r\n    editor.events.on('link.beforeRemove', _onRemove)\r\n\r\n    if (editor.$wp) {\r\n      _syncFiles()\r\n      editor.events.on('contentChanged', _syncFiles)\r\n    }\r\n\r\n    _initInsertPopup(true)\r\n  }\r\n\r\n  return {\r\n    _init: _init,\r\n    showInsertPopup: showInsertPopup,\r\n    upload: upload,\r\n    insert: insert,\r\n    back: back,\r\n    hideProgressBar: hideProgressBar\r\n  }\r\n}\r\n\r\n// Insert file button.\r\nFE.DefineIcon('insertFile', {\r\n  NAME: 'file-o',\r\n  FA5NAME: 'file',\r\n  SVG_KEY: 'insertFile'\r\n})\r\nFE.RegisterCommand('insertFile', {\r\n  title: 'Upload File',\r\n  undo: false,\r\n  focus: true,\r\n  refreshAfterCallback: false,\r\n  popup: true,\r\n  callback: function () {\r\n    if (!this.popups.isVisible('file.insert')) {\r\n      this.file.showInsertPopup()\r\n    }\r\n    else {\r\n      if (this.$el.find('.fr-marker').length) {\r\n        this.events.disableBlur()\r\n        this.selection.restore()\r\n      }\r\n      this.popups.hide('file.insert');\r\n    }\r\n  },\r\n  plugin: 'file'\r\n})\r\n\r\nFE.DefineIcon('fileBack', { NAME: 'arrow-left', SVG_KEY: 'back' })\r\nFE.RegisterCommand('fileBack', {\r\n  title: 'Back',\r\n  undo: false,\r\n  focus: false,\r\n  back: true,\r\n  refreshAfterCallback: false,\r\n  callback: function () {\r\n    this.file.back()\r\n  },\r\n  refresh: function ($btn) {\r\n    if (!this.opts.toolbarInline) {\r\n      $btn.addClass('fr-hidden')\r\n      $btn.next('.fr-separator').addClass('fr-hidden')\r\n    }\r\n    else {\r\n      $btn.removeClass('fr-hidden')\r\n      $btn.next('.fr-separator').removeClass('fr-hidden')\r\n    }\r\n  }\r\n})\r\n\r\nFE.RegisterCommand('fileDismissError', {\r\n  title: 'OK',\r\n  callback: function () {\r\n    this.file.hideProgressBar(true)\r\n  }\r\n})\r\n"],"names":["Object","assign","FE","POPUP_TEMPLATES","DEFAULTS","fileUpload","fileUploadURL","fileUploadParam","fileUploadParams","fileUploadToS3","fileUploadToAzure","fileUploadMethod","fileMaxSize","fileAllowedTypes","fileInsertButtons","fileUseSelectedText","PLUGINS","file","editor","$","DEFAULT_FILE_UPLOAD_URL","BAD_LINK","MISSING_LINK","ERROR_DURING_UPLOAD","BAD_RESPONSE","MAX_SIZE_EXCEEDED","BAD_FILE_TYPE","NO_CORS_IE","error_messages","showInsertPopup","$btn","$tb","find","$popup","popups","get","_initInsertPopup","hideProgressBar","hasClass","refresh","setContainer","isVisible","button","getPosition","left","top","show","outerHeight","position","forSelection","showProgressBar","removeClass","addClass","hide","_setProgressMessage","language","translate","dismiss","events","focus","message","progress","$layer","text","css","_showErrorMessage","$message_header","disableBlur","insert","link","response","edit","on","selection","restore","opts","length","html","$file","$el","removeAttr","undo","saveStep","_syncFiles","trigger","_parseResponse","resp","JSON","parse","_throwError","ex","_parseXMLResponse","key","_fileUploaded","url","status","responseXML","responseText","responseURL","_fileUploadError","_fileUploadProgress","e","lengthComputable","complete","loaded","total","code","_fileUploadAborted","_browserUpload","reader","FileReader","onload","result","binary","atob","split","array","i","push","charCodeAt","window","URL","createObjectURL","Blob","Uint8Array","type","name","readAsDataURL","upload","files","size","indexOf","replace","form_data","drag_support","formdata","FormData","append","keyStart","Date","getTime","params","hasOwnProperty","uploadURL","region","bucket","fileURL","azureKey","encodeURI","account","container","SASToken","xhr","core","getXHR","uploadDate","toUTCString","accessKey","azureAccount","azureContainer","urls","pop","headerResource","urlResource","stringToSign","signatureBytes","cryptoJSPlugin","cryptoJS","HmacSHA256","enc","Base64","signature","toString","authHeader","setRequestHeader","call","onerror","onprogress","onabort","off","readyState","abort","send","_bindInsertEvents","$on","preventDefault","stopPropagation","dt","originalEvent","dataTransfer","inst","data","helpers","isIOS","blur","enableBlur","val","_hideInsertPopup","delayed","onHide","file_buttons","splice","buildList","upload_layer","id","join","toLowerCase","progress_bar_layer","template","buttons","progress_bar","create","_onRemove","node","_drop","markers","remove","insertAtPoint","replaceWith","MARKERS","hideAll","$sc","pageX","pageY","_initEvents","$win","key_code","which","KEYCODE","ESC","back","toolbar","showInline","c_files","Array","prototype","slice","el","querySelectorAll","file_srcs","getAttribute","_init","$wp","DefineIcon","NAME","FA5NAME","SVG_KEY","RegisterCommand","title","refreshAfterCallback","popup","callback","plugin","toolbarInline","next"],"mappings":"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"}